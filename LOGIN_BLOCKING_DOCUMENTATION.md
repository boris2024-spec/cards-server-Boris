# Система блокировки пользователей после неудачных попыток входа

## Описание

Система автоматически блокирует пользователей на 24 часа после 3 неудачных попыток входа с одним email адресом, даже при использовании неправильного пароля.

## Функциональность

### Основные возможности:
- **Отслеживание попыток**: Каждая неудачная попытка входа сохраняется в базе данных
- **Автоматическая блокировка**: После 3 неудачных попыток пользователь блокируется на 24 часа
- **Информативные сообщения**: Пользователь получает информацию о количестве оставшихся попыток
- **Автоматическая разблокировка**: Блокировка снимается через 24 часа
- **Сброс при успешном входе**: Счетчик попыток сбрасывается при правильном пароле
- **Административный сброс**: Администратор может принудительно сбросить блокировку

## Структура базы данных

### Модель LoginAttempt
```javascript
{
  email: String,           // Email пользователя
  attempts: Number,        // Количество неудачных попыток
  blockedUntil: Date,      // Дата окончания блокировки
  lastAttempt: Date        // Дата последней попытки
}
```

## API Endpoints

### POST /api/users/login
Вход в систему с проверкой блокировки

**Ответы при блокировке:**
- `423 Locked` - Аккаунт заблокирован
- `401 Unauthorized` - Неверные данные с указанием оставшихся попыток

### PATCH /api/users/reset-login-attempts
Сброс попыток входа (только для администраторов)

**Тело запроса:**
```json
{
  "email": "user@example.com"
}
```

## Логика работы

### Алгоритм блокировки:
1. При неудачной попытке входа система проверяет существующие записи
2. Увеличивает счетчик попыток или создает новую запись
3. После 3 попыток устанавливает `blockedUntil` на 24 часа вперед
4. При каждом входе проверяется статус блокировки

### Разблокировка:
- **Автоматическая**: Через 24 часа (TTL индекс в MongoDB)
- **При успешном входе**: Запись удаляется
- **Административная**: Через API endpoint

## Безопасность

### Защита от атак:
- **Brute Force**: Блокировка после 3 попыток
- **Rate Limiting**: По email адресу
- **Временная блокировка**: 24 часа
- **Логирование**: Все попытки сохраняются

### Ограничения:
- Блокировка применяется только по email
- Не защищает от атак с разных email адресов
- Требует активного мониторинга

## Тестирование

### Автоматические тесты:
```bash
npm test -- user.blocking.test.js
```

### Ручное тестирование:
```powershell
.\demo_user_blocking.ps1
```

## Конфигурация

### Константы (в loginAttemptService.js):
```javascript
const MAX_ATTEMPTS = 3;                    // Максимум попыток
const BLOCK_DURATION = 24 * 60 * 60 * 1000; // 24 часа в мс
```

### Переменные среды:
- `ADMIN_REG_CODE` - Код для создания администратора

## Мониторинг

### Рекомендуемые метрики:
- Количество заблокированных аккаунтов
- Частота неудачных попыток входа
- Время восстановления доступа
- Использование административного сброса

### Логи:
Все события блокировки логируются в консоль для мониторинга.

## Дальнейшее развитие

### Возможные улучшения:
- **IP-based blocking**: Блокировка по IP адресу
- **Progressive delays**: Увеличивающиеся задержки
- **CAPTCHA integration**: Проверка на робота
- **Email notifications**: Уведомления о блокировке
- **Audit trail**: Детальный журнал событий

### Интеграция с внешними системами:
- **Redis**: Для быстрого кэширования
- **Monitoring tools**: Prometheus, Grafana
- **Alert systems**: Уведомления администраторов
